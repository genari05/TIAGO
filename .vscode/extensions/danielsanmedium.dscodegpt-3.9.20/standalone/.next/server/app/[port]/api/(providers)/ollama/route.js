"use strict";(()=>{var e={};e.id=7650,e.ids=[7650],e.modules={65372:e=>{e.exports=require("better-sqlite3-multiple-ciphers")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},20629:e=>{e.exports=require("fs/promises")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},74026:e=>{e.exports=require("string_decoder")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},98061:e=>{e.exports=require("node:assert")},92761:e=>{e.exports=require("node:async_hooks")},72254:e=>{e.exports=require("node:buffer")},17718:e=>{e.exports=require("node:child_process")},40027:e=>{e.exports=require("node:console")},6005:e=>{e.exports=require("node:crypto")},65714:e=>{e.exports=require("node:diagnostics_channel")},30604:e=>{e.exports=require("node:dns")},15673:e=>{e.exports=require("node:events")},88849:e=>{e.exports=require("node:http")},42725:e=>{e.exports=require("node:http2")},87503:e=>{e.exports=require("node:net")},38846:e=>{e.exports=require("node:perf_hooks")},39630:e=>{e.exports=require("node:querystring")},84492:e=>{e.exports=require("node:stream")},31764:e=>{e.exports=require("node:tls")},41041:e=>{e.exports=require("node:url")},47261:e=>{e.exports=require("node:util")},93746:e=>{e.exports=require("node:util/types")},24086:e=>{e.exports=require("node:worker_threads")},65628:e=>{e.exports=require("node:zlib")},44174:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>l,requestAsyncStorage:()=>u,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>c});var o=r(49303),a=r(88716),n=r(60670),i=r(52382),p=e([i]);i=(p.then?(await p)():p)[0];let d=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/[port]/api/(providers)/ollama/route",pathname:"/[port]/api/ollama",filename:"route",bundlePath:"app/[port]/api/(providers)/ollama/route"},resolvedPagePath:"/Users/maol/WebstormProjects/Trabajo/codegpt-nextjs/app/[port]/api/(providers)/ollama/route.ts",nextConfigOutput:"standalone",userland:i}),{requestAsyncStorage:u,staticGenerationAsyncStorage:c,serverHooks:m}=d,x="/[port]/api/(providers)/ollama/route";function l(){return(0,n.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:c})}s()}catch(e){s(e)}})},52382:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{HEAD:()=>g,POST:()=>q});var o=r(92810),a=r(82687),n=r(56342),i=r(61740),p=r(315),l=r(76129),d=r(75421),u=r(89874),c=r(87320),m=r(94750),x=e([o,a,n,p,u,m]);async function h(e,t){let r=e.body?.getReader();if(!r)throw Error("No reader available");let s="";return new ReadableStream({async start(e){let o=new TextDecoder;for(t?.onStart?.();;){let{done:a,value:n}=await r.read();if(a){e.close(),t?.onFinal?.(s),t?.onCompletion?.(s);return}for(let r of o.decode(n).split("\n"))try{if(!r)continue;let o=JSON.parse(r.trim()),a=o?.message?.content;a&&(e.enqueue(a),t?.onToken?.(a),s+=a)}catch{}}},cancel(){t?.onFinal?.(s),r.releaseLock()}})}async function g(){let e=a.ZI.getByProvider("Ollama")?.custom_link;return Response.json("",{status:e?200:401})}async function q(e){let{messages:t}=await e.json(),r=(t=await (0,p.Dz)({messages:t,provider:"Ollama"}))[t.length-1],{image:s}=r,x=s?"llava":e.headers.get("model")||"mistral",g=e.headers.get("filePath"),q=e.headers.get("promptType"),f=await m.Z.getLanguage(),w=await m.Z.getIdeLanguage(),y=e.headers.get("fileName")??"",v="Chat",b=r?.codeSelection??"";if(q){v=q+"CodeGPT";let e=await (0,l.u)({promptType:q,cleanPromptText:r.content+b,language:w});e&&(t[t.length-1].content=e+r.content+b)}if(g){let e=JSON.stringify(await (0,o.getFileContent)(g),null,2);t[t.length-1].content+=`${g}

    ${e}`}if(!t.some(e=>"system"===e.role)){let e=await (0,i.Ox)({provider:"ollama",model:x});t.unshift({role:"system",content:e||"I am a helpful programming expert assistant. If you ask me a question that is rooted in truth. Follow the user's instructions with precision and attention to detail. Provide the code in a single block. Minimize any additional text."})}s&&(t[t.length-1].images=[s.split("base64,")[1]]);let k=(0,c.q)(t.map(e=>e.content).join(""));try{let e={model:x||"mistral",messages:t};t=(0,p.VL)(t);let r=a.ZI.getByProvider("Ollama"),s=r?.custom_link,o=await fetch((s||"http://localhost:11434")+"/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!o.ok){let e=o.status;if(404===e)return Response.json({message:"Error Model not found.",status:e},{status:e});return Response.json({message:"Error fetching Ollama completion",status:e},{status:e})}let i=await h(o,{onFinal:async e=>{let t=(0,c.q)(e);await (0,n.sendEvent)({eventName:v,provider:"Ollama",model:x??"mistral",promptTokens:k,completionTokens:t,totalTokens:k+t,statusCode:o.status})}}),l=t.slice(0,-1).some(e=>e.content.includes(b));if(g||b&&(q||!l)){let e=await (0,u.VU)([`<p style='display: flex; align-items: center; gap: 0.5rem;'>${q?`<span class='command command-bordered command-with-icon' data-command='command'><span class='max-w-48 overflow-hidden text-ellipsis whitespace-pre break-words pr-1 font-mono text-sm text-foreground'>${q}</span></span>`:""}${y?`<span class='command command-bordered command-with-icon animate-slideIn relative h-auto items-center gap-1 overflow-hidden' data-id=${f} data-language=${f}><span class='max-w-48 overflow-hidden text-ellipsis whitespace-pre break-words pr-1 font-mono text-sm text-foreground'>${y}</span></span>`:""}${g?`<span class='command command-bordered command-with-icon animate-slideIn relative h-auto items-center gap-1 overflow-hidden' data-language=${g.split("/").pop()?.split(".").pop()}><span class='max-w-48 overflow-hidden text-ellipsis whitespace-pre break-words pr-1 font-mono text-sm text-foreground'>${g.split("/").pop()}</span></span>`:""}</p>

`],i);return new d.w(e)}return new d.w(i)}catch(e){if((0,n.sendEvent)({eventName:v,provider:"Ollama",model:x??"mistral",promptTokens:k,totalTokens:k,statusCode:e.status??500}),e.message.includes("fetch failed"))return Response.json({message:"Ollama is not running.",status:500},{status:500});return Response.json({message:e.message,status:e.status??500},{status:e.status??500})}}[o,a,n,p,u,m]=x.then?(await x)():x,s()}catch(e){s(e)}})},49303:(e,t,r)=>{e.exports=r(30517)},75421:(e,t,r)=>{r.d(t,{w:()=>s});class s extends Response{constructor(e,t){super(e,{...t,status:200,headers:{"Content-Type":"text/plain; charset=utf-8","X-Experimental-Stream-Data":"false",...t?.headers}})}}},87320:(e,t,r)=>{r.d(t,{q:()=>o});var s=r(3375);let o=(e,t)=>(0,s.b9)(t??"gpt-4").encode(e).length??0}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,1242,4599,9092,6510,9712,8811,3375,8268,2687,7807,9836,1371,2377],()=>r(44174));module.exports=s})();